# Customizing the data reduction  <a name="configuration"></a>

## Selection of most appropriate calibrations

```{include} ../common/appropriate_calibrations.md
```

## Quality reports
```{include} ../common/quality_plots.md
```

## Configuration of parameters
```{include} ../common/configure_reduction.md
```

## Troubleshooting <a name="troubleshooting"> </a>

This section provides guidance for diagnosing and resolving 
common issues encountered during the XSHOOTER data-reduction cascade.

### Master darks <a name="master_darks"> </a>

`sph_ifs_master_dark` produces the detector dark-current calibration (`IFS_MASTER_DARK`) and generates a static bad-pixel map (`IFS_STATIC_BADPIXELMAP`).

If too few bad pixels are detected, decrease `ifs.master_dark.sigma_clip` from the default value of 5 to 3 to make the clipping more aggressive.

The parameters `ifs.master_dark.min_acceptable` and `ifs.master_dark.max_acceptable` are currently set to 0 and 800, respectively (default values: âˆ’100 and 1000).

### Distortion map <a name="distortion_map"> </a>

The pipeline recipe `sph_ifs_distortion_map`, intended to measure the geometric distortion of IFS frames, has been found to be insufficiently robust. 
Calibration data acquired close in time can yield inconsistent distortion solutions, including variations in the derived central axes. 
When applied to science data, these discrepancies can introduce artificial distortions rather than correct them. 
For this reason, the recipe is not included in the standard workflow.

The dominant distortion component is a stable anamorphism of approximately 0.6%. 
This can be corrected in a simple and reproducible way by rescaling the detector coordinates, 
multiplying the X and Y axes by factors of 1.0059 and 1.0011, respectively.

### Wavelength calibration <a name="wavel_calib"> </a>

The consortium identified significant systematic wavelength shifts when using the pipeline product `IFS_SPECPOS` generated by recipe `sph_ifs_spectra_positions`. 
To mitigate this issue, an ad hoc correction was developed and implemented in IDL. 
The corresponding implementation within the pipeline, however, does not yet reproduce the same level of performance and remains under evaluation.

To facilitate independent verification of the wavelength solution, the recipe `sph_ifs_wave_calib` produces a wavelength-calibrated data cube of the arc lamp exposure. 
This allows users to directly assess the quality and stability of the wavelength calibration.

### Star center <a name="star_center"> </a>

The recipe `sph_ifs_star_center`, which processes OBJECT,CENTER observations obtained with the IFS, 
has been found to introduce significant systematic errors in the derived stellar position. 
As a consequence, its output is not used by the science reduction recipe. 

### Spectral deconvolution <a name="spt_deconv"> </a>

When `sph_ifs_science_dr` reduces science data with `ifs.science_dr.spec_deconv` = TRUE, 
the following recipe parameters are ignored and internally set to fixed values:

- `ifs.science_dr.order` = 5 
- `ifs.science_dr.user_cent` = FALSE 
- `ifs.science_dr.cx` = 0 (unused since `user_cent` = FALSE)
- `ifs.science_dr.cy` = 0 (unused since `user_cent` = FALSE)
- `ifs.science_dr.reflambda` = 1.0 
- `ifs.science_dr.fwhm` = 2.0

These choices reflect the experience of the [High Contrast Data Center](https://hc-dc.cnrs.fr/).

### Science data reduction <a name="science_dr"> </a>

Following the consortium recommendation, `ifs.science_dr.spec_deconv` is set to FALSE in recipe `sph_ifs_science_dr`, 
as the current pipeline implementation relies on an outdated algorithm.
Because the science case is not known a priori, `ifs.science_dr.use_adi` is set to 0.

At the Data Center, crosstalk and bad-pixel corrections were historically performed using IDL scripts. 
These algorithms are now implemented in the pipeline and can be enabled via `ifs.science_dr.badpixco.apply` and `ifs.science_dr.xtalkco.apply` (both FALSE by default).

The large-scale crosstalk correction may improve point-source detection but can negatively impact extended sources (e.g., discs). 
It must therefore be enabled separately by setting `ifs.science_dr.xtalkco.largescale.apply` to TRUE.

 ---
Go to [top](#configuration)

 ---
Go to SPHERE-IFS EDPS tutorial [index](../sphere/index)